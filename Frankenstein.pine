//@version=5
indicator("Frankenstein Ultimate Pro - ATM Logic", overlay=true)

// ===== SETTINGS =====
speedLen   = input.int(10, "Fast TEMA (Reaction)")
trendLen   = input.int(80, "Global Trend (LSMA)")
rrRatio    = input.float(1.5, "Risk:Reward Ratio")
volMult    = input.float(1.2, "ATM Volatility Threshold")

// ===== 1. ZERO-LAG TEMA (The "Trigger") =====
tema(src, len) =>
    e1 = ta.ema(src, len)
    e2 = ta.ema(e1, len)
    e3 = ta.ema(e2, len)
    3 * (e1 - e2) + e3

fastTEMA = tema(close, speedLen)

// ===== 2. PREDICTIVE TREND (The "Filter") =====
trendLSMA = ta.linreg(close, trendLen, 0)

// ===== 3. ATM-STYLE VOLATILITY FILTER =====
atr = ta.atr(14)
expectedMove = ta.sma(atr, 20) * volMult
isVolatile = (high - low) > expectedMove

// ===== 4. MOMENTUM DELTA =====
rsi14 = ta.rsi(close, 14)
stochK = ta.sma(ta.stoch(rsi14, rsi14, rsi14, 14), 3)

// ===== LIVE ENTRY LOGIC =====
longSignal  = ta.crossover(close, fastTEMA) and close > trendLSMA and stochK < 80 and isVolatile
shortSignal = ta.crossunder(close, fastTEMA) and close < trendLSMA and stochK > 20 and isVolatile

// ===== DYNAMIC RISK MANAGEMENT =====
var float sl = na
var float tp = na

if longSignal
    sl := ta.lowest(low, 3) 
    tp := close + (close - sl) * rrRatio
    label.new(bar_index, low, "ðŸš€ LIVE BUY\nTP: " + str.tostring(tp, "#.##"), yloc=yloc.belowbar, color=color.lime, style=label.style_label_up, size=size.small)

if shortSignal
    sl := ta.highest(high, 3)
    tp := close - (sl - close) * rrRatio
    label.new(bar_index, high, "ðŸ“‰ LIVE SELL\nTP: " + str.tostring(tp, "#.##"), yloc=yloc.abovebar, color=color.red, style=label.style_label_down, textcolor=color.white, size=size.small)

// ===== PLOTTING =====
lineColor = close > trendLSMA ? color.new(color.lime, 0) : color.new(color.red, 0)
plot(trendLSMA, color=lineColor, linewidth=3, title="Trend Line")
plot(fastTEMA, color=color.new(color.yellow, 0), linewidth=1, title="Fast Line")

// Target/Stop Markers
plot(longSignal or shortSignal ? tp : na, color=color.white, style=plot.style_cross, linewidth=2, title="Target")
plot(longSignal or shortSignal ? sl : na, color=color.orange, style=plot.style_cross, linewidth=2, title="Stop")
